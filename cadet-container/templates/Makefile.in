CS1101S_REPO_LOC=
MOUNT_CADET_REPO=
MOUNT_CADET_FRONTEND_REPO=
WEB_PORT=
API_PORT=
POSTGRES_PORT=

build: Dockerfile secrets.exs .env templates/docker-run.sh
	docker build -t cadet .

rebuild: Dockerfile secrets.exs .env templates/docker-run.sh
	docker build -t cadet --no-cache .

run:
	CUR_DATE=$$(date +"%y%m%d-%H%M%S"); \
	LOG_LOC=$$(mktemp -d log-$${CUR_DATE}---XXX); \
	LOG_LOC=$$(readlink --canonicalize-existing $${LOG_LOC}); \
	docker run \
		-p ${WEB_PORT}:80 -p ${API_PORT}:4001 -p ${POSTGRES_PORT}:5234 \
		--mount type=bind,source=$(CS1101S_REPO_LOC),target=/cs1101s-host,readonly \
		--mount type=bind,source=$${LOG_LOC},target=/log \
		$(MOUNT_CADET_REPO) $(MOUNT_CADET_FRONTEND_REPO) \
		cadet

all:
	make build
	make run

stop:
	docker rm $$(docker stop $$(docker ps -a -q --filter ancestor=cadet --format="{{.ID}}"))
